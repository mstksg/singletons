<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Data/Singletons/Single.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{- Data/Singletons/Single.hs
<a name="line-2"></a>
<a name="line-3"></a>(c) Richard Eisenberg 2013
<a name="line-4"></a>eir@cis.upenn.edu
<a name="line-5"></a>
<a name="line-6"></a>This file contains functions to refine constructs to work with singleton
<a name="line-7"></a>types. It is an internal module to the singletons package.
<a name="line-8"></a>-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell, TupleSections, ParallelListComp, CPP #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Single</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-layout'>(</span><span class='hs-conid'>Quasi</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Deriving</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Deriving</span><span class='hs-varop'>.</span><span class='hs-conid'>Bounded</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Deriving</span><span class='hs-varop'>.</span><span class='hs-conid'>Enum</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Promote</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Promote</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span> <span class='hs-varid'>promoteM</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Promote</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Single</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Single</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Single</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Single</span><span class='hs-varop'>.</span><span class='hs-conid'>Eq</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Singletons</span><span class='hs-varop'>.</span><span class='hs-conid'>Partition</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Desugar</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>{-
<a name="line-38"></a>How singletons works
<a name="line-39"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-40"></a>
<a name="line-41"></a>Singling, on the surface, doesn't seem all that complicated. Promote the type,
<a name="line-42"></a>and singletonize all the terms. That's essentially what was done singletons &lt; 1.0.
<a name="line-43"></a>But, now we want to deal with higher-order singletons. So, things are a little
<a name="line-44"></a>more complicated.
<a name="line-45"></a>
<a name="line-46"></a>The way to understand all of this is that *every* variable maps to something
<a name="line-47"></a>of type (Sing t), for an appropriately-kinded t. This includes functions, which
<a name="line-48"></a>use the "SLambda" instance of Sing. To apply singleton functions, we use the
<a name="line-49"></a>applySing function.
<a name="line-50"></a>
<a name="line-51"></a>That, in and of itself, wouldn't be too hard, but it's really annoying from
<a name="line-52"></a>the user standpoint. After dutifully singling `map`, a user doesn't want to
<a name="line-53"></a>have to use two `applySing`s to actually use it. So, any let-bound identifier
<a name="line-54"></a>is eta-expanded so that the singled type has the same number of arrows as
<a name="line-55"></a>the original type. (If there is no original type signature, then it has as
<a name="line-56"></a>many arrows as the original had patterns.) Then, we store a use of one of the
<a name="line-57"></a>singFunX functions in the SgM environment so that every use of a let-bound
<a name="line-58"></a>identifier has a proper type (Sing t).
<a name="line-59"></a>
<a name="line-60"></a>It would be consistent to avoid this eta-expansion for local lets (as opposed
<a name="line-61"></a>to top-level lets), but that seemed like more bother than it was worth. It
<a name="line-62"></a>may also be possible to be cleverer about nested eta-expansions and contractions,
<a name="line-63"></a>but that also seemed not to be worth it. Though I haven't tested it, my hope
<a name="line-64"></a>is that the eta-expansions and contractions have no runtime effect, especially
<a name="line-65"></a>because SLambda is a *newtype* instance, not a *data* instance.
<a name="line-66"></a>
<a name="line-67"></a>Note that to maintain the desired invariant, we must also be careful to eta-
<a name="line-68"></a>contract constructors. This is the point of buildDataLets.
<a name="line-69"></a>-}</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="genSingletons"></a><span class='hs-comment'>-- | Generate singleton definitions from a type that is already defined.</span>
<a name="line-72"></a><span class='hs-comment'>-- For example, the singletons package itself uses</span>
<a name="line-73"></a><span class='hs-comment'>--</span>
<a name="line-74"></a><span class='hs-comment'>-- &gt; $(genSingletons [''Bool, ''Maybe, ''Either, ''[]])</span>
<a name="line-75"></a><span class='hs-comment'>--</span>
<a name="line-76"></a><span class='hs-comment'>-- to generate singletons for Prelude types.</span>
<a name="line-77"></a><span class='hs-definition'>genSingletons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a><span class='hs-definition'>genSingletons</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-79"></a>  <span class='hs-varid'>checkForRep</span> <span class='hs-varid'>names</span>
<a name="line-80"></a>  <span class='hs-varid'>ddecs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singInfo</span> <span class='hs-varop'>&lt;=&lt;</span> <span class='hs-varid'>dsInfo</span> <span class='hs-varop'>&lt;=&lt;</span> <span class='hs-varid'>reifyWithWarning</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-81"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decsToTH</span> <span class='hs-varid'>ddecs</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="singletons"></a><span class='hs-comment'>-- | Make promoted and singleton versions of all declarations given, retaining</span>
<a name="line-84"></a><span class='hs-comment'>-- the original declarations.</span>
<a name="line-85"></a><span class='hs-comment'>-- See &lt;<a href="http://www.cis.upenn.edu/~eir/packages/singletons/README.html">http://www.cis.upenn.edu/~eir/packages/singletons/README.html</a>&gt; for</span>
<a name="line-86"></a><span class='hs-comment'>-- further explanation.</span>
<a name="line-87"></a><span class='hs-definition'>singletons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a><span class='hs-definition'>singletons</span> <span class='hs-varid'>qdecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-89"></a>  <span class='hs-varid'>decs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>qdecs</span>
<a name="line-90"></a>  <span class='hs-varid'>singDecs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapDesugar</span> <span class='hs-varid'>singTopLevelDecs</span> <span class='hs-varid'>decs</span>
<a name="line-91"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>decs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>singDecs</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="singletonsOnly"></a><span class='hs-comment'>-- | Make promoted and singleton versions of all declarations given, discarding</span>
<a name="line-94"></a><span class='hs-comment'>-- the original declarations. Note that a singleton based on a datatype needs</span>
<a name="line-95"></a><span class='hs-comment'>-- the original datatype, so this will fail if it sees any datatype declarations.</span>
<a name="line-96"></a><span class='hs-comment'>-- Classes, instances, and functions are all fine.</span>
<a name="line-97"></a><span class='hs-definition'>singletonsOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a><span class='hs-definition'>singletonsOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapDesugar</span> <span class='hs-varid'>singTopLevelDecs</span><span class='hs-layout'>)</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="singEqInstances"></a><span class='hs-comment'>-- | Create instances of 'SEq' and type-level '(:==)' for each type in the list</span>
<a name="line-101"></a><span class='hs-definition'>singEqInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a><span class='hs-definition'>singEqInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singEqInstance</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="singEqInstance"></a><span class='hs-comment'>-- | Create instance of 'SEq' and type-level '(:==)' for the given type</span>
<a name="line-105"></a><span class='hs-definition'>singEqInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a><span class='hs-definition'>singEqInstance</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-107"></a>  <span class='hs-varid'>promotion</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteEqInstance</span> <span class='hs-varid'>name</span>
<a name="line-108"></a>  <span class='hs-varid'>dec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singEqualityInstance</span> <span class='hs-varid'>sEqClassDesc</span> <span class='hs-varid'>name</span>
<a name="line-109"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dec</span> <span class='hs-varop'>++</span> <span class='hs-varid'>promotion</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="singEqInstancesOnly"></a><span class='hs-comment'>-- | Create instances of 'SEq' (only -- no instance for '(:==)', which 'SEq' generally</span>
<a name="line-112"></a><span class='hs-comment'>-- relies on) for each type in the list</span>
<a name="line-113"></a><span class='hs-definition'>singEqInstancesOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a><span class='hs-definition'>singEqInstancesOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singEqInstanceOnly</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="singEqInstanceOnly"></a><span class='hs-comment'>-- | Create instances of 'SEq' (only -- no instance for '(:==)', which 'SEq' generally</span>
<a name="line-117"></a><span class='hs-comment'>-- relies on) for the given type</span>
<a name="line-118"></a><span class='hs-definition'>singEqInstanceOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-119"></a><span class='hs-definition'>singEqInstanceOnly</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singEqualityInstance</span> <span class='hs-varid'>sEqClassDesc</span> <span class='hs-varid'>name</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="singDecideInstances"></a><span class='hs-comment'>-- | Create instances of 'SDecide' for each type in the list.</span>
<a name="line-122"></a><span class='hs-definition'>singDecideInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-123"></a><span class='hs-definition'>singDecideInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singDecideInstance</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="singDecideInstance"></a><span class='hs-comment'>-- | Create instance of 'SDecide' for the given type.</span>
<a name="line-126"></a><span class='hs-definition'>singDecideInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-127"></a><span class='hs-definition'>singDecideInstance</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singEqualityInstance</span> <span class='hs-varid'>sDecideClassDesc</span> <span class='hs-varid'>name</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="singEqualityInstance"></a><span class='hs-comment'>-- generalized function for creating equality instances</span>
<a name="line-130"></a><span class='hs-definition'>singEqualityInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>EqualityClassDesc</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-131"></a><span class='hs-definition'>singEqualityInstance</span> <span class='hs-varid'>desc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>className</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-132"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tvbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDataD</span> <span class='hs-layout'>(</span><span class='hs-str'>"I cannot make an instance of "</span> <span class='hs-varop'>++</span>
<a name="line-133"></a>                            <span class='hs-varid'>show</span> <span class='hs-varid'>className</span> <span class='hs-varop'>++</span> <span class='hs-str'>" for it."</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-134"></a>  <span class='hs-varid'>dtvbs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsTvb</span> <span class='hs-varid'>tvbs</span>
<a name="line-135"></a>  <span class='hs-varid'>dcons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsCon</span> <span class='hs-varid'>cons</span>
<a name="line-136"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarK</span> <span class='hs-varop'>.</span> <span class='hs-varid'>extractTvbName</span><span class='hs-layout'>)</span> <span class='hs-varid'>dtvbs</span>
<a name="line-137"></a>      <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DConK</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyvars</span>
<a name="line-138"></a>  <span class='hs-varid'>aName</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>qNewName</span> <span class='hs-str'>"a"</span>
<a name="line-139"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>aVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>aName</span>
<a name="line-140"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>scons</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singM</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singCtor</span> <span class='hs-varid'>aVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>dcons</span>
<a name="line-141"></a>  <span class='hs-varid'>eqInstance</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkEqualityInstance</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>scons</span> <span class='hs-varid'>desc</span>
<a name="line-142"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decToTH</span> <span class='hs-varid'>eqInstance</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="singOrdInstances"></a><span class='hs-comment'>-- | Create instances of 'SOrd' for the given types</span>
<a name="line-145"></a><span class='hs-definition'>singOrdInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-146"></a><span class='hs-definition'>singOrdInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singOrdInstance</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="singOrdInstance"></a><span class='hs-comment'>-- | Create instance of 'SOrd' for the given type</span>
<a name="line-149"></a><span class='hs-definition'>singOrdInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-150"></a><span class='hs-definition'>singOrdInstance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singInstance</span> <span class='hs-varid'>mkOrdInstance</span> <span class='hs-str'>"Ord"</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="singBoundedInstances"></a><span class='hs-comment'>-- | Create instances of 'SBounded' for the given types</span>
<a name="line-153"></a><span class='hs-definition'>singBoundedInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-154"></a><span class='hs-definition'>singBoundedInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singBoundedInstance</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="singBoundedInstance"></a><span class='hs-comment'>-- | Create instance of 'SBounded' for the given type</span>
<a name="line-157"></a><span class='hs-definition'>singBoundedInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-158"></a><span class='hs-definition'>singBoundedInstance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singInstance</span> <span class='hs-varid'>mkBoundedInstance</span> <span class='hs-str'>"Bounded"</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="singEnumInstances"></a><span class='hs-comment'>-- | Create instances of 'SEnum' for the given types</span>
<a name="line-161"></a><span class='hs-definition'>singEnumInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a><span class='hs-definition'>singEnumInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singEnumInstance</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="singEnumInstance"></a><span class='hs-comment'>-- | Create instance of 'SEnum' for the given type</span>
<a name="line-165"></a><span class='hs-definition'>singEnumInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-166"></a><span class='hs-definition'>singEnumInstance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singInstance</span> <span class='hs-varid'>mkEnumInstance</span> <span class='hs-str'>"Enum"</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="singInstance"></a><span class='hs-definition'>singInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span>
<a name="line-169"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-conid'>UInstDecl</span><span class='hs-layout'>)</span>
<a name="line-170"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-171"></a><span class='hs-definition'>singInstance</span> <span class='hs-varid'>mk_inst</span> <span class='hs-varid'>inst_name</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-172"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tvbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDataD</span> <span class='hs-layout'>(</span><span class='hs-str'>"I cannot make an instance of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>inst_name</span>
<a name="line-173"></a>                            <span class='hs-varop'>++</span> <span class='hs-str'>" for it."</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-174"></a>  <span class='hs-varid'>dtvbs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsTvb</span> <span class='hs-varid'>tvbs</span>
<a name="line-175"></a>  <span class='hs-varid'>dcons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsCon</span> <span class='hs-varid'>cons</span>
<a name="line-176"></a>  <span class='hs-varid'>raw_inst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_inst</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConT</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tvbToType</span> <span class='hs-varid'>dtvbs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>dcons</span>
<a name="line-177"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>a_inst</span><span class='hs-layout'>,</span> <span class='hs-varid'>decs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteM</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span>
<a name="line-178"></a>                    <span class='hs-varid'>promoteInstanceDec</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varid'>raw_inst</span>
<a name="line-179"></a>  <span class='hs-varid'>decs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singDecsM</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>singInstD</span> <span class='hs-varid'>a_inst</span>
<a name="line-180"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decsToTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>decs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>decs'</span><span class='hs-layout'>)</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="singInfo"></a><span class='hs-definition'>singInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DDec</span><span class='hs-keyglyph'>]</span>
<a name="line-183"></a><span class='hs-definition'>singInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTyConI</span> <span class='hs-varid'>dec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-184"></a>  <span class='hs-varid'>singTopLevelDecs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dec</span><span class='hs-keyglyph'>]</span>
<a name="line-185"></a><span class='hs-definition'>singInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>DPrimTyConI</span> <span class='hs-sel'>_name</span> <span class='hs-sel'>_numArgs</span> <span class='hs-sel'>_unlifted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-186"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Singling of primitive type constructors not supported"</span>
<a name="line-187"></a><span class='hs-definition'>singInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarI</span> <span class='hs-sel'>_name</span> <span class='hs-sel'>_ty</span> <span class='hs-sel'>_mdec</span> <span class='hs-sel'>_fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-188"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Singling of value info not supported"</span>
<a name="line-189"></a><span class='hs-definition'>singInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTyVarI</span> <span class='hs-sel'>_name</span> <span class='hs-sel'>_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-190"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Singling of type variable info not supported"</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="singTopLevelDecs"></a><span class='hs-definition'>singTopLevelDecs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DDec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DDec</span><span class='hs-keyglyph'>]</span>
<a name="line-193"></a><span class='hs-definition'>singTopLevelDecs</span> <span class='hs-varid'>locals</span> <span class='hs-varid'>raw_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-194"></a>  <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withLocalDeclarations</span> <span class='hs-varid'>locals</span> <span class='hs-varop'>$</span> <span class='hs-varid'>expand</span> <span class='hs-varid'>raw_decls</span>     <span class='hs-comment'>-- expand type synonyms</span>
<a name="line-195"></a>  <span class='hs-conid'>PDecs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pd_let_decs</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>letDecls</span>
<a name="line-196"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pd_class_decs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classes</span>
<a name="line-197"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pd_instance_decs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span>
<a name="line-198"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pd_data_decs</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>datas</span> <span class='hs-layout'>}</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>partitionDecs</span> <span class='hs-varid'>decls</span>
<a name="line-199"></a>
<a name="line-200"></a>  <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>letDecEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>classes'</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>promDecls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteM</span> <span class='hs-varid'>locals</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-201"></a>    <span class='hs-varid'>promoteDataDecs</span> <span class='hs-varid'>datas</span>
<a name="line-202"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>letDecEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteLetDecs</span> <span class='hs-varid'>noPrefix</span> <span class='hs-varid'>letDecls</span>
<a name="line-203"></a>    <span class='hs-varid'>classes'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>promoteClassDec</span> <span class='hs-varid'>classes</span>
<a name="line-204"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>meth_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>lde_types</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cd_lde</span><span class='hs-layout'>)</span> <span class='hs-varid'>classes</span>
<a name="line-205"></a>    <span class='hs-varid'>insts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteInstanceDec</span> <span class='hs-varid'>meth_sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span>
<a name="line-206"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>letDecEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>classes'</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts'</span><span class='hs-layout'>)</span>
<a name="line-207"></a>
<a name="line-208"></a>  <span class='hs-varid'>singDecsM</span> <span class='hs-varid'>locals</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-209"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>letBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>buildDataLets</span> <span class='hs-varid'>datas</span>
<a name="line-210"></a>                <span class='hs-varop'>++</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>buildMethLets</span> <span class='hs-varid'>classes</span>
<a name="line-211"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>newLetDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>newDecls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLets</span> <span class='hs-varid'>letBinds</span> <span class='hs-varop'>$</span>
<a name="line-212"></a>                               <span class='hs-varid'>singLetDecEnv</span> <span class='hs-varid'>letDecEnv</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-213"></a>                                 <span class='hs-varid'>newDataDecls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>singDataD</span> <span class='hs-varid'>datas</span>
<a name="line-214"></a>                                 <span class='hs-varid'>newClassDecls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>singClassD</span> <span class='hs-varid'>classes'</span>
<a name="line-215"></a>                                 <span class='hs-varid'>newInstDecls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>singInstD</span> <span class='hs-varid'>insts'</span>
<a name="line-216"></a>                                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>newDataDecls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>newClassDecls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>newInstDecls</span><span class='hs-layout'>)</span>
<a name="line-217"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>promDecls</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DLetDec</span> <span class='hs-varid'>newLetDecls</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>newDecls</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="buildDataLets"></a><span class='hs-comment'>-- see comment at top of file</span>
<a name="line-220"></a><span class='hs-definition'>buildDataLets</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-221"></a><span class='hs-definition'>buildDataLets</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataDecl</span> <span class='hs-sel'>_nd</span> <span class='hs-sel'>_name</span> <span class='hs-sel'>_tvbs</span> <span class='hs-varid'>cons</span> <span class='hs-sel'>_derivings</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-222"></a>  <span class='hs-varid'>concatMap</span> <span class='hs-varid'>con_num_args</span> <span class='hs-varid'>cons</span>
<a name="line-223"></a>  <span class='hs-keyword'>where</span>
<a name="line-224"></a>    <span class='hs-varid'>con_num_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-225"></a>    <span class='hs-varid'>con_num_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCon</span> <span class='hs-sel'>_tvbs</span> <span class='hs-sel'>_cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-226"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>tysOfConFields</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-227"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>singDataConName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-228"></a>      <span class='hs-conop'>:</span> <span class='hs-varid'>rec_selectors</span> <span class='hs-varid'>fields</span>
<a name="line-229"></a>
<a name="line-230"></a>    <span class='hs-varid'>rec_selectors</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DConFields</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-231"></a>    <span class='hs-varid'>rec_selectors</span> <span class='hs-layout'>(</span><span class='hs-conid'>DNormalC</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-232"></a>    <span class='hs-varid'>rec_selectors</span> <span class='hs-layout'>(</span><span class='hs-conid'>DRecC</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-233"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fstOf3</span> <span class='hs-varid'>fields</span> <span class='hs-keyword'>in</span>
<a name="line-234"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-235"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-236"></a>
<a name="line-237"></a><a name="buildMethLets"></a><span class='hs-comment'>-- see comment at top of file</span>
<a name="line-238"></a><span class='hs-definition'>buildMethLets</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UClassDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-239"></a><span class='hs-definition'>buildMethLets</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_lde</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetDecEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lde_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_sigs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-240"></a>  <span class='hs-varid'>map</span> <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>meth_sigs</span><span class='hs-layout'>)</span>
<a name="line-241"></a>  <span class='hs-keyword'>where</span>
<a name="line-242"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>meth_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-243"></a>      <span class='hs-layout'>(</span> <span class='hs-varid'>meth_name</span>
<a name="line-244"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>countArgs</span> <span class='hs-varid'>meth_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>meth_name</span><span class='hs-layout'>)</span>
<a name="line-245"></a>                                        <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>singValName</span> <span class='hs-varid'>meth_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="singClassD"></a><span class='hs-definition'>singClassD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AClassDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DDec</span>
<a name="line-248"></a><span class='hs-definition'>singClassD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_cxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_cxt</span>
<a name="line-249"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>cd_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_name</span>
<a name="line-250"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>cd_tvbs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_tvbs</span>
<a name="line-251"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>cd_fds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_fundeps</span>
<a name="line-252"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>cd_lde</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetDecEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lde_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>default_defns</span>
<a name="line-253"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>lde_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_sigs</span>
<a name="line-254"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>lde_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixities</span>
<a name="line-255"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>lde_proms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoted_defaults</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-256"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>sing_sigs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kis</span><span class='hs-layout'>)</span>
<a name="line-257"></a>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unzip4</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singTySig</span> <span class='hs-varid'>no_meth_defns</span> <span class='hs-varid'>meth_sigs</span><span class='hs-layout'>)</span>
<a name="line-258"></a>                           <span class='hs-varid'>meth_names</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>meth_names</span><span class='hs-layout'>)</span>
<a name="line-259"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>default_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_default_sig</span> <span class='hs-varid'>meth_names</span> <span class='hs-varid'>sing_sigs</span>
<a name="line-260"></a>      <span class='hs-varid'>res_ki_map</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>meth_names</span>
<a name="line-261"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>always_sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-262"></a>  <span class='hs-varid'>sing_meths</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>singLetDecRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>)</span>
<a name="line-263"></a>                                             <span class='hs-varid'>res_ki_map</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-264"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>default_defns</span><span class='hs-layout'>)</span>
<a name="line-265"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>fixities'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>singInfixDecl</span><span class='hs-layout'>)</span> <span class='hs-varid'>fixities</span>
<a name="line-266"></a>  <span class='hs-varid'>cls_cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>singPred</span> <span class='hs-varid'>cls_cxt</span>
<a name="line-267"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>kproxies</span><span class='hs-layout'>,</span> <span class='hs-varid'>kproxy_pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkKProxies</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>extractTvbName</span> <span class='hs-varid'>cls_tvbs</span><span class='hs-layout'>)</span>
<a name="line-268"></a>
<a name="line-269"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DClassD</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_cxt'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>kproxy_pred</span><span class='hs-layout'>)</span>
<a name="line-270"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>singClassName</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>kproxies</span>
<a name="line-271"></a>                   <span class='hs-varid'>cls_fundeps</span>   <span class='hs-comment'>-- they are fine without modification</span>
<a name="line-272"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DLetDec</span> <span class='hs-layout'>(</span><span class='hs-varid'>sing_sigs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sing_meths</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fixities'</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>default_sigs</span><span class='hs-layout'>)</span>
<a name="line-273"></a>  <span class='hs-keyword'>where</span>
<a name="line-274"></a>    <span class='hs-varid'>no_meth_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Internal error: can't find declared method type"</span>
<a name="line-275"></a>    <span class='hs-varid'>always_sig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Internal error: no signature for default method"</span>
<a name="line-276"></a>    <span class='hs-varid'>meth_names</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varid'>meth_sigs</span>
<a name="line-277"></a>
<a name="line-278"></a>    <span class='hs-varid'>mk_default_sig</span> <span class='hs-varid'>meth_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>DSigD</span> <span class='hs-varid'>s_name</span> <span class='hs-varid'>sty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-279"></a>      <span class='hs-conid'>DDefaultSigD</span> <span class='hs-varid'>s_name</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>add_constraints</span> <span class='hs-varid'>meth_name</span> <span class='hs-varid'>sty</span>
<a name="line-280"></a>    <span class='hs-varid'>mk_default_sig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Internal error: a singled signature isn't a signature."</span>
<a name="line-281"></a>
<a name="line-282"></a>    <span class='hs-varid'>add_constraints</span> <span class='hs-varid'>meth_name</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- Maybe monad</span>
<a name="line-283"></a>      <span class='hs-varid'>prom_dflt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>meth_name</span> <span class='hs-varid'>promoted_defaults</span>
<a name="line-284"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>default_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>DAppPr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConPr</span> <span class='hs-varid'>equalityName</span><span class='hs-layout'>)</span>
<a name="line-285"></a>                               <span class='hs-keyglyph'>[</span> <span class='hs-varid'>foldApply</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>meth_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-286"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>foldApply</span> <span class='hs-varid'>prom_dflt</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-287"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DForallT</span> <span class='hs-varid'>tvbs</span> <span class='hs-layout'>(</span><span class='hs-varid'>default_pred</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ravel</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-288"></a>      <span class='hs-keyword'>where</span>
<a name="line-289"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tvbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unravel</span> <span class='hs-varid'>sty</span>
<a name="line-290"></a>        <span class='hs-varid'>tvs</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tvbToType</span> <span class='hs-varid'>tvbs</span>
<a name="line-291"></a>
<a name="line-292"></a>
<a name="line-293"></a><a name="singInstD"></a><span class='hs-definition'>singInstD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AInstDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DDec</span>
<a name="line-294"></a><span class='hs-definition'>singInstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>id_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_name</span>
<a name="line-295"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>id_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>id_meths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ann_meths</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-296"></a>  <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>singPred</span> <span class='hs-varid'>cxt</span>
<a name="line-297"></a>  <span class='hs-varid'>inst_kis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>promoteType</span> <span class='hs-varid'>inst_tys</span>
<a name="line-298"></a>  <span class='hs-varid'>meths</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>sing_meth</span><span class='hs-layout'>)</span> <span class='hs-varid'>ann_meths</span>
<a name="line-299"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DInstanceD</span> <span class='hs-varid'>cxt'</span>
<a name="line-300"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>DAppT</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConT</span> <span class='hs-varid'>s_inst_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>kindParam</span> <span class='hs-varid'>inst_kis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-301"></a>                     <span class='hs-varid'>meths</span><span class='hs-layout'>)</span>
<a name="line-302"></a>
<a name="line-303"></a>  <span class='hs-keyword'>where</span>
<a name="line-304"></a>    <span class='hs-varid'>s_inst_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singClassName</span> <span class='hs-varid'>inst_name</span>
<a name="line-305"></a>
<a name="line-306"></a>    <span class='hs-varid'>sing_meth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ALetDecRHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DDec</span><span class='hs-keyglyph'>]</span>
<a name="line-307"></a>    <span class='hs-varid'>sing_meth</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-308"></a>      <span class='hs-varid'>mb_s_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsReify</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-309"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>s_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_s_info</span> <span class='hs-keyword'>of</span>
<a name="line-310"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarI</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DForallT</span> <span class='hs-varid'>cls_kproxy_tvbs</span> <span class='hs-sel'>_cls_pred</span> <span class='hs-varid'>s_ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-311"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>class_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>extract_kv</span> <span class='hs-varid'>cls_kproxy_tvbs</span>
<a name="line-312"></a>              <span class='hs-varid'>extract_kv</span> <span class='hs-layout'>(</span><span class='hs-conid'>DKindedTV</span> <span class='hs-sel'>_kproxyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConK</span> <span class='hs-sel'>_kproxyTy</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DVarK</span> <span class='hs-varid'>kv</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv</span>
<a name="line-313"></a>              <span class='hs-varid'>extract_kv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"sing_meth cannot extract a kind variable"</span>
<a name="line-314"></a>
<a name="line-315"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>sing_tvbs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_pred</span><span class='hs-layout'>,</span> <span class='hs-sel'>_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unravel</span> <span class='hs-varid'>s_ty</span>
<a name="line-316"></a>
<a name="line-317"></a>          <span class='hs-varid'>inst_kis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>promoteType</span> <span class='hs-varid'>inst_tys</span>
<a name="line-318"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>subst</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>class_kvs</span> <span class='hs-varid'>inst_kis</span><span class='hs-layout'>)</span>
<a name="line-319"></a>              <span class='hs-varid'>m_res_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyword'>of</span>
<a name="line-320"></a>                <span class='hs-sel'>_sing</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-layout'>(</span><span class='hs-sel'>_prom_func</span> <span class='hs-varop'>`DSigT`</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>substKind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span>
<a name="line-321"></a>                <span class='hs-keyword'>_</span>                                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-322"></a>
<a name="line-323"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>substKindInType</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>s_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>extractTvbName</span> <span class='hs-varid'>sing_tvbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_res_ki</span><span class='hs-layout'>)</span>
<a name="line-324"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-325"></a>          <span class='hs-varid'>mb_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsReify</span> <span class='hs-varid'>name</span>
<a name="line-326"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_info</span> <span class='hs-keyword'>of</span>
<a name="line-327"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarI</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DForallT</span> <span class='hs-varid'>cls_tvbs</span> <span class='hs-sel'>_cls_pred</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-328"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>extractTvbName</span> <span class='hs-varid'>cls_tvbs</span><span class='hs-layout'>)</span>
<a name="line-329"></a>                                            <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-330"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>s_ty</span><span class='hs-layout'>,</span> <span class='hs-sel'>_num_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singType</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-331"></a>                                                                 <span class='hs-layout'>(</span><span class='hs-varid'>substType</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span>
<a name="line-332"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>s_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span>
<a name="line-333"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Cannot find type of method "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>name</span>
<a name="line-334"></a>
<a name="line-335"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>kind_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>m_res_ki</span>
<a name="line-336"></a>      <span class='hs-varid'>meth'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singLetDecRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>)</span>
<a name="line-337"></a>                             <span class='hs-varid'>kind_map</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs</span>
<a name="line-338"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>DLetDec</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DSigD</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>s_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>meth'</span><span class='hs-keyglyph'>]</span>
<a name="line-339"></a>
<a name="line-340"></a><a name="singLetDecEnv"></a><span class='hs-definition'>singLetDecEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ALetDecEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>DLetDec</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-341"></a><span class='hs-definition'>singLetDecEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetDecEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lde_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defns</span>
<a name="line-342"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>lde_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>types</span>
<a name="line-343"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>lde_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>infix_decls</span>
<a name="line-344"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>lde_proms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>proms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-345"></a>              <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-346"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>prom_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>proms</span>
<a name="line-347"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>typeSigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>letBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvarNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kis</span><span class='hs-layout'>)</span>
<a name="line-348"></a>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unzip4</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>singTySig</span> <span class='hs-varid'>defns</span> <span class='hs-varid'>types</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prom_list</span>
<a name="line-349"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>infix_decls'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>singInfixDecl</span><span class='hs-layout'>)</span> <span class='hs-varid'>infix_decls</span>
<a name="line-350"></a>      <span class='hs-varid'>res_ki_map</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span>
<a name="line-351"></a>                                                       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>prom_list</span> <span class='hs-varid'>res_kis</span> <span class='hs-keyglyph'>]</span>
<a name="line-352"></a>  <span class='hs-varid'>bindLets</span> <span class='hs-varid'>letBinds</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-353"></a>    <span class='hs-varid'>let_decs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>singLetDecRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>tyvarNames</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ki_map</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-354"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-355"></a>    <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-356"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>infix_decls'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>typeSigs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>let_decs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-357"></a>
<a name="line-358"></a><a name="singInfixDecl"></a><span class='hs-definition'>singInfixDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DLetDec</span>
<a name="line-359"></a><span class='hs-definition'>singInfixDecl</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>name</span>
<a name="line-360"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUpcase</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-361"></a>    <span class='hs-comment'>-- is it a tycon name or a datacon name??</span>
<a name="line-362"></a>    <span class='hs-comment'>-- it *must* be a datacon name, because symbolic tycons</span>
<a name="line-363"></a>    <span class='hs-comment'>-- can't be promoted. This is terrible.</span>
<a name="line-364"></a>    <span class='hs-conid'>DInfixD</span> <span class='hs-varid'>fixity</span> <span class='hs-layout'>(</span><span class='hs-varid'>singDataConName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-365"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DInfixD</span> <span class='hs-varid'>fixity</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="singTySig"></a><span class='hs-definition'>singTySig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>ALetDecRHS</span>  <span class='hs-comment'>-- definitions</span>
<a name="line-368"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>DType</span>       <span class='hs-comment'>-- type signatures</span>
<a name="line-369"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DType</span>   <span class='hs-comment'>-- the type is the promoted type, not the type sig!</span>
<a name="line-370"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DLetDec</span>               <span class='hs-comment'>-- the new type signature</span>
<a name="line-371"></a>                 <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- the let-bind entry</span>
<a name="line-372"></a>                 <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- the scoped tyvar names in the tysig</span>
<a name="line-373"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DKind</span>           <span class='hs-comment'>-- the result kind in the tysig</span>
<a name="line-374"></a>                 <span class='hs-layout'>)</span>
<a name="line-375"></a><span class='hs-definition'>singTySig</span> <span class='hs-varid'>defns</span> <span class='hs-varid'>types</span> <span class='hs-varid'>name</span> <span class='hs-varid'>prom_ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-376"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>sName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>in</span>
<a name="line-377"></a>  <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>name</span> <span class='hs-varid'>types</span> <span class='hs-keyword'>of</span>
<a name="line-378"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-379"></a>      <span class='hs-varid'>num_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>guess_num_args</span>
<a name="line-380"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>sty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_sing_ty</span> <span class='hs-varid'>num_args</span>
<a name="line-381"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DSigD</span> <span class='hs-varid'>sName</span> <span class='hs-varid'>sty</span>
<a name="line-382"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-varid'>num_args</span> <span class='hs-varid'>prom_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>sName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-383"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>)</span>
<a name="line-384"></a>             <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>)</span>
<a name="line-385"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-386"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>sty</span><span class='hs-layout'>,</span> <span class='hs-varid'>num_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singType</span> <span class='hs-varid'>prom_ty</span> <span class='hs-varid'>ty</span>
<a name="line-387"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DSigD</span> <span class='hs-varid'>sName</span> <span class='hs-varid'>sty</span>
<a name="line-388"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-varid'>num_args</span> <span class='hs-varid'>prom_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>sName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-389"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar_names</span><span class='hs-layout'>)</span>
<a name="line-390"></a>             <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res_ki</span> <span class='hs-layout'>)</span>
<a name="line-391"></a>  <span class='hs-keyword'>where</span>
<a name="line-392"></a>    <span class='hs-varid'>guess_num_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>Int</span>
<a name="line-393"></a>    <span class='hs-varid'>guess_num_args</span> <span class='hs-keyglyph'>=</span>
<a name="line-394"></a>      <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>name</span> <span class='hs-varid'>defns</span> <span class='hs-keyword'>of</span>
<a name="line-395"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"Internal error: promotion known for something not let-bound."</span>
<a name="line-396"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AValue</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-397"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AFunction</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-398"></a>
<a name="line-399"></a>      <span class='hs-comment'>-- create a Sing t1 -&gt; Sing t2 -&gt; ... type of a given arity and result type</span>
<a name="line-400"></a>    <span class='hs-varid'>mk_sing_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-401"></a>    <span class='hs-varid'>mk_sing_ty</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-402"></a>      <span class='hs-varid'>arg_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>qNewName</span> <span class='hs-str'>"arg"</span><span class='hs-layout'>)</span>
<a name="line-403"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DForallT</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DPlainTV</span> <span class='hs-varid'>arg_names</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-404"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ravel</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>nm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>singFamily</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_names</span><span class='hs-layout'>)</span>
<a name="line-405"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>singFamily</span> <span class='hs-varop'>`DAppT`</span>
<a name="line-406"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>apply</span> <span class='hs-varid'>prom_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>arg_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-407"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>arg_names</span> <span class='hs-layout'>)</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="singLetDecRHS"></a><span class='hs-definition'>singLetDecRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-410"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>DKind</span>   <span class='hs-comment'>-- result kind (might not be known)</span>
<a name="line-411"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ALetDecRHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DLetDec</span>
<a name="line-412"></a><span class='hs-definition'>singLetDecRHS</span> <span class='hs-sel'>_bound_names</span> <span class='hs-sel'>_res_kis</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>AValue</span> <span class='hs-varid'>prom</span> <span class='hs-varid'>num_arrows</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-413"></a>  <span class='hs-conid'>DValD</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarPa</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-414"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>wrapUnSingFun</span> <span class='hs-varid'>num_arrows</span> <span class='hs-varid'>prom</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-415"></a><span class='hs-definition'>singLetDecRHS</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>res_kis</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>AFunction</span> <span class='hs-varid'>prom_fun</span> <span class='hs-varid'>num_arrows</span> <span class='hs-varid'>clauses</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-416"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvar_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>name</span> <span class='hs-varid'>bound_names</span> <span class='hs-keyword'>of</span>
<a name="line-417"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-418"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ns</span>
<a name="line-419"></a>      <span class='hs-varid'>res_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>name</span> <span class='hs-varid'>res_kis</span>
<a name="line-420"></a>  <span class='hs-keyword'>in</span>
<a name="line-421"></a>  <span class='hs-conid'>DFunD</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-422"></a>        <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singClause</span> <span class='hs-varid'>prom_fun</span> <span class='hs-varid'>num_arrows</span> <span class='hs-varid'>tyvar_names</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-varid'>clauses</span>
<a name="line-423"></a>
<a name="line-424"></a><a name="singClause"></a><span class='hs-definition'>singClause</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DType</span>   <span class='hs-comment'>-- the promoted function</span>
<a name="line-425"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>     <span class='hs-comment'>-- the number of arrows in the type. If this is more</span>
<a name="line-426"></a>                      <span class='hs-comment'>-- than the number of patterns, we need to eta-expand</span>
<a name="line-427"></a>                      <span class='hs-comment'>-- with unSingFun.</span>
<a name="line-428"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- the names of the forall'd vars in the type sig of this</span>
<a name="line-429"></a>                      <span class='hs-comment'>-- function. This list should have at least the length as the</span>
<a name="line-430"></a>                      <span class='hs-comment'>-- number of patterns in the clause</span>
<a name="line-431"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DKind</span>   <span class='hs-comment'>-- result kind, if known</span>
<a name="line-432"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ADClause</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DClause</span>
<a name="line-433"></a><span class='hs-definition'>singClause</span> <span class='hs-varid'>prom_fun</span> <span class='hs-varid'>num_arrows</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>res_ki</span>
<a name="line-434"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>ADClause</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-435"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>sPats</span><span class='hs-layout'>,</span> <span class='hs-varid'>prom_pats</span><span class='hs-layout'>)</span>
<a name="line-436"></a>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>var_proms</span><span class='hs-layout'>)</span> <span class='hs-conid'>Parameter</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats</span>
<a name="line-437"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>equalities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>prom_pats</span>
<a name="line-438"></a>      <span class='hs-comment'>-- This res_ki stuff is necessary when we need to propagate result-</span>
<a name="line-439"></a>      <span class='hs-comment'>-- based type-inference. It was inspired by toEnum. (If you remove</span>
<a name="line-440"></a>      <span class='hs-comment'>-- this, that should fail to compile.)</span>
<a name="line-441"></a>      <span class='hs-varid'>applied_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ki</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varop'>`DSigT`</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ki</span> <span class='hs-varop'>$</span>
<a name="line-442"></a>                   <span class='hs-varid'>foldl</span> <span class='hs-varid'>apply</span> <span class='hs-varid'>prom_fun</span> <span class='hs-varid'>prom_pats</span>
<a name="line-443"></a>  <span class='hs-varid'>sBody</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindTyVarsEq</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>applied_ty</span> <span class='hs-varid'>equalities</span> <span class='hs-varop'>$</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span>
<a name="line-444"></a>    <span class='hs-comment'>-- when calling unSingFun, the prom_pats aren't in scope, so we use the</span>
<a name="line-445"></a>    <span class='hs-comment'>-- bound_names instead</span>
<a name="line-446"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>pattern_bound_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>const</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>pats</span>
<a name="line-447"></a>       <span class='hs-comment'>-- this does eta-expansion. See comment at top of file.</span>
<a name="line-448"></a>      <span class='hs-varid'>sBody'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapUnSingFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>num_arrows</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span>
<a name="line-449"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>apply</span> <span class='hs-varid'>prom_fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>pattern_bound_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sBody</span>
<a name="line-450"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DClause</span> <span class='hs-varid'>sPats</span> <span class='hs-varid'>sBody'</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="PatternContext"></a><span class='hs-comment'>-- we need to know where a pattern is to anticipate when</span>
<a name="line-453"></a><a name="PatternContext"></a><span class='hs-comment'>-- GHC's brain might explode</span>
<a name="line-454"></a><a name="PatternContext"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PatternContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetBinding</span>
<a name="line-455"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseStatement</span>
<a name="line-456"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Parameter</span>
<a name="line-457"></a>                    <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-458"></a>
<a name="line-459"></a><a name="checkIfBrainWillExplode"></a><span class='hs-definition'>checkIfBrainWillExplode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PatternContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-460"></a><span class='hs-definition'>checkIfBrainWillExplode</span> <span class='hs-conid'>CaseStatement</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-461"></a><span class='hs-definition'>checkIfBrainWillExplode</span> <span class='hs-conid'>Parameter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-462"></a><span class='hs-definition'>checkIfBrainWillExplode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span>
<a name="line-463"></a>  <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Can't use a singleton pattern outside of a case-statement or\n"</span> <span class='hs-varop'>++</span>
<a name="line-464"></a>         <span class='hs-str'>"do expression: GHC's brain will explode if you try. (Do try it!)"</span>
<a name="line-465"></a>
<a name="line-466"></a><span class='hs-comment'>-- Note [No wildcards in singletons]</span>
<a name="line-467"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-468"></a><span class='hs-comment'>--</span>
<a name="line-469"></a><span class='hs-comment'>-- We forbid patterns with wildcards during singletonization. Why? Because</span>
<a name="line-470"></a><span class='hs-comment'>-- singletonizing a pattern also must produce a type expression equivalent</span>
<a name="line-471"></a><span class='hs-comment'>-- to the pattern, for use in bindTyVars. Wildcards get in the way of this.</span>
<a name="line-472"></a><span class='hs-comment'>-- Thus, we de-wild patterns during promotion, and put the de-wilded patterns</span>
<a name="line-473"></a><span class='hs-comment'>-- in the ADExp AST.</span>
<a name="line-474"></a>
<a name="line-475"></a><a name="singPat"></a><span class='hs-definition'>singPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span>   <span class='hs-comment'>-- from term-level names to type-level names</span>
<a name="line-476"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatternContext</span>
<a name="line-477"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DPat</span>
<a name="line-478"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DPat</span><span class='hs-layout'>,</span> <span class='hs-conid'>DType</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- the type form of the pat</span>
<a name="line-479"></a><span class='hs-definition'>singPat</span> <span class='hs-sel'>_var_proms</span> <span class='hs-sel'>_patCxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLitPa</span> <span class='hs-sel'>_lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-480"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Singling of literal patterns not yet supported"</span>
<a name="line-481"></a><span class='hs-definition'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-sel'>_patCxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarPa</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-482"></a>  <span class='hs-varid'>tyname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>name</span> <span class='hs-varid'>var_proms</span> <span class='hs-keyword'>of</span>
<a name="line-483"></a>              <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span>
<a name="line-484"></a>                <span class='hs-varid'>fail</span> <span class='hs-str'>"Internal error: unknown variable when singling pattern"</span>
<a name="line-485"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>tyname</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tyname</span>
<a name="line-486"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarPa</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DVarT</span> <span class='hs-varid'>tyname</span><span class='hs-layout'>)</span>
<a name="line-487"></a><span class='hs-definition'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConPa</span> <span class='hs-varid'>name</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-488"></a>  <span class='hs-varid'>checkIfBrainWillExplode</span> <span class='hs-varid'>patCxt</span>
<a name="line-489"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats</span>
<a name="line-490"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DConPa</span> <span class='hs-layout'>(</span><span class='hs-varid'>singDataConName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats'</span>
<a name="line-491"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>apply</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteValRhs</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-492"></a><span class='hs-definition'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTildePa</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-493"></a>  <span class='hs-varid'>qReportWarning</span>
<a name="line-494"></a>    <span class='hs-str'>"Lazy pattern converted into regular pattern during singleton generation."</span>
<a name="line-495"></a>  <span class='hs-varid'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span> <span class='hs-varid'>pat</span>
<a name="line-496"></a><span class='hs-definition'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DBangPa</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-497"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singPat</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>patCxt</span> <span class='hs-varid'>pat</span>
<a name="line-498"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DBangPa</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-499"></a><span class='hs-definition'>singPat</span> <span class='hs-sel'>_var_proms</span> <span class='hs-sel'>_patCxt</span> <span class='hs-conid'>DWildPa</span> <span class='hs-keyglyph'>=</span>
<a name="line-500"></a>  <span class='hs-comment'>-- See Note [No wildcards in singletons]</span>
<a name="line-501"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Internal error: wildcard seen during singleton generation"</span>
<a name="line-502"></a>
<a name="line-503"></a><span class='hs-comment'>-- Note [Annotate case return type]</span>
<a name="line-504"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-505"></a><span class='hs-comment'>--</span>
<a name="line-506"></a><span class='hs-comment'>-- We're straining GHC's type inference here. One particular trouble area</span>
<a name="line-507"></a><span class='hs-comment'>-- is determining the return type of a GADT pattern match. In general, GHC</span>
<a name="line-508"></a><span class='hs-comment'>-- cannot infer return types of GADT pattern matches because the return type</span>
<a name="line-509"></a><span class='hs-comment'>-- becomes "untouchable" in the case matches. See the OutsideIn paper. But,</span>
<a name="line-510"></a><span class='hs-comment'>-- during singletonization, we *know* the return type. So, just add a type</span>
<a name="line-511"></a><span class='hs-comment'>-- annotation. See #54.</span>
<a name="line-512"></a>
<a name="line-513"></a><span class='hs-comment'>-- Note [Why error is so special]</span>
<a name="line-514"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-515"></a><span class='hs-comment'>-- Some of the transformations that happen before this point produce impossible</span>
<a name="line-516"></a><span class='hs-comment'>-- case matches. We must be careful when processing these so as not to make</span>
<a name="line-517"></a><span class='hs-comment'>-- an error GHC will complain about. When binding the case-match variables, we</span>
<a name="line-518"></a><span class='hs-comment'>-- normally include an equality constraint saying that the scrutinee is equal</span>
<a name="line-519"></a><span class='hs-comment'>-- to the matched pattern. But, we can't do this in inaccessible matches, because</span>
<a name="line-520"></a><span class='hs-comment'>-- equality is bogus, and GHC (rightly) complains. However, we then have another</span>
<a name="line-521"></a><span class='hs-comment'>-- problem, because GHC doesn't have enough information when type-checking the</span>
<a name="line-522"></a><span class='hs-comment'>-- RHS of the inaccessible match to deem it type-safe. The solution: treat error</span>
<a name="line-523"></a><span class='hs-comment'>-- as super-special, so that GHC doesn't look too hard at singletonized error</span>
<a name="line-524"></a><span class='hs-comment'>-- calls. Specifically, DON'T do the applySing stuff. Just use sError, which</span>
<a name="line-525"></a><span class='hs-comment'>-- has a custom type (Sing x -&gt; a) anyway.</span>
<a name="line-526"></a>
<a name="line-527"></a><a name="singExp"></a><span class='hs-definition'>singExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ADExp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DExp</span>
<a name="line-528"></a>  <span class='hs-comment'>-- See Note [Why error is so special]</span>
<a name="line-529"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADVarE</span> <span class='hs-varid'>err</span> <span class='hs-varop'>`ADAppE`</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-530"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>err</span> <span class='hs-varop'>==</span> <span class='hs-varid'>errorName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DAppE</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-layout'>(</span><span class='hs-varid'>singValName</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>arg</span>
<a name="line-531"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADVarE</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarE</span> <span class='hs-varid'>name</span>
<a name="line-532"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADConE</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupConE</span> <span class='hs-varid'>name</span>
<a name="line-533"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADLitE</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singLit</span> <span class='hs-varid'>lit</span>
<a name="line-534"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADAppE</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-535"></a>  <span class='hs-varid'>e1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>e1</span>
<a name="line-536"></a>  <span class='hs-varid'>e2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>e2</span>
<a name="line-537"></a>  <span class='hs-comment'>-- `applySing undefined x` kills type inference, because GHC can't figure</span>
<a name="line-538"></a>  <span class='hs-comment'>-- out the type of `undefined`. So we don't emit that code.</span>
<a name="line-539"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>e1'</span>
<a name="line-540"></a>  <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>e1'</span>
<a name="line-541"></a>  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>applySingName</span><span class='hs-layout'>)</span> <span class='hs-varop'>`DAppE`</span> <span class='hs-varid'>e1'</span> <span class='hs-varop'>`DAppE`</span> <span class='hs-varid'>e2'</span>
<a name="line-542"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADLamE</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>prom_lam</span> <span class='hs-varid'>names</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-543"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>sNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>singValName</span> <span class='hs-varid'>names</span>
<a name="line-544"></a>  <span class='hs-varid'>exp'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindTyVars</span> <span class='hs-varid'>var_proms</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>apply</span> <span class='hs-varid'>prom_lam</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarT</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>var_proms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-545"></a>          <span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span>
<a name="line-546"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapSingFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-varid'>prom_lam</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DLamE</span> <span class='hs-varid'>sNames</span> <span class='hs-varid'>exp'</span>
<a name="line-547"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADCaseE</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>prom_exp</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>ret_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-548"></a>    <span class='hs-comment'>-- See Note [Annotate case return type]</span>
<a name="line-549"></a>  <span class='hs-conid'>DSigE</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCaseE</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>singMatch</span> <span class='hs-varid'>prom_exp</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-550"></a>        <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>singFamily</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-varid'>ret_ty</span><span class='hs-layout'>)</span>
<a name="line-551"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADLetE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-552"></a>  <span class='hs-varid'>uncurry</span> <span class='hs-conid'>DLetE</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>singLetDecEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-553"></a><span class='hs-definition'>singExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADSigE</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-554"></a>  <span class='hs-varid'>fail</span> <span class='hs-str'>"Singling of explicit type annotations not yet supported."</span>
<a name="line-555"></a>
<a name="line-556"></a><a name="isException"></a><span class='hs-definition'>isException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DExp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-557"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>undefinedName</span>
<a name="line-558"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConE</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-559"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLitE</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-560"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DAppE</span> <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameBase</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>==</span> <span class='hs-str'>"sError"</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-561"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DAppE</span> <span class='hs-varid'>fun</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>fun</span>
<a name="line-562"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLamE</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-563"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCaseE</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>e</span>
<a name="line-564"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLetE</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>e</span>
<a name="line-565"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DSigE</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>e</span>
<a name="line-566"></a><span class='hs-definition'>isException</span> <span class='hs-layout'>(</span><span class='hs-conid'>DStaticE</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isException</span> <span class='hs-varid'>e</span>
<a name="line-567"></a>
<a name="line-568"></a><a name="singMatch"></a><span class='hs-definition'>singMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DType</span>  <span class='hs-comment'>-- ^ the promoted scrutinee</span>
<a name="line-569"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ADMatch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DMatch</span>
<a name="line-570"></a><span class='hs-definition'>singMatch</span> <span class='hs-varid'>prom_scrut</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADMatch</span> <span class='hs-varid'>var_proms</span> <span class='hs-varid'>prom_match</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-571"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>sPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>prom_pat</span><span class='hs-layout'>)</span>
<a name="line-572"></a>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>var_proms</span><span class='hs-layout'>)</span> <span class='hs-conid'>CaseStatement</span> <span class='hs-varid'>pat</span>
<a name="line-573"></a>        <span class='hs-comment'>-- why DAppT below? See comment near decl of ADMatch in LetDecEnv.</span>
<a name="line-574"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>equality</span>
<a name="line-575"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DVarPa</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pat</span>
<a name="line-576"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADVarE</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-varop'>`ADAppE`</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exp</span>
<a name="line-577"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>err</span> <span class='hs-varop'>==</span> <span class='hs-varid'>errorName</span>   <span class='hs-comment'>-- See Note [Why error is so special]</span>
<a name="line-578"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-comment'>-- no equality from impossible case.</span>
<a name="line-579"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>prom_pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>prom_scrut</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-580"></a>  <span class='hs-varid'>sExp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindTyVarsEq</span> <span class='hs-varid'>var_proms</span> <span class='hs-layout'>(</span><span class='hs-varid'>prom_match</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-varid'>prom_pat</span><span class='hs-layout'>)</span> <span class='hs-varid'>equality</span> <span class='hs-varop'>$</span>
<a name="line-581"></a>          <span class='hs-varid'>singExp</span> <span class='hs-varid'>exp</span>
<a name="line-582"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DMatch</span> <span class='hs-varid'>sPat</span> <span class='hs-varid'>sExp</span>
<a name="line-583"></a>
<a name="line-584"></a><a name="singLit"></a><span class='hs-definition'>singLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SgM</span> <span class='hs-conid'>DExp</span>
<a name="line-585"></a><span class='hs-definition'>singLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntegerL</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-586"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-587"></a>                <span class='hs-conid'>DVarE</span> <span class='hs-varid'>sFromIntegerName</span> <span class='hs-varop'>`DAppE`</span>
<a name="line-588"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>DVarE</span> <span class='hs-varid'>singMethName</span> <span class='hs-varop'>`DSigE`</span>
<a name="line-589"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>singFamily</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-conid'>DLitT</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-590"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>sLit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>singLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntegerL</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-591"></a>                   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DVarE</span> <span class='hs-varid'>sNegateName</span> <span class='hs-varop'>`DAppE`</span> <span class='hs-varid'>sLit</span>
<a name="line-592"></a><span class='hs-definition'>singLit</span> <span class='hs-varid'>lit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-593"></a>  <span class='hs-varid'>prom_lit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteLitExp</span> <span class='hs-varid'>lit</span>
<a name="line-594"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DVarE</span> <span class='hs-varid'>singMethName</span> <span class='hs-varop'>`DSigE`</span> <span class='hs-layout'>(</span><span class='hs-varid'>singFamily</span> <span class='hs-varop'>`DAppT`</span> <span class='hs-varid'>prom_lit</span><span class='hs-layout'>)</span>
</pre></body>
</html>
